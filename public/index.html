<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>BTC TX Battle Royale</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://YOUR-DOMAIN/og-3x2.png","button":{"title":"Launch Game","action":{"type":"launch_frame","name":"BTC TX Battle Royale","url":"https://YOUR-DOMAIN","splashImageUrl":"https://YOUR-DOMAIN/splash-200x200.png","splashBackgroundColor":"#f7931a"}}'/>
  <style>
    body{font-family:system-ui;background:#111;color:#fff;text-align:center;margin:0;padding:2rem}
    input{padding:.6rem 1rem;font-size:1.2rem;border-radius:8px;border:none;margin:.5rem 0}
    button{padding:.6rem 1.5rem;font-size:1.2rem;border-radius:8px;border:none;background:#f7931a;color:#000;font-weight:700}
    #shareBox{background:rgba(247,147,26,.1);border:1px solid rgba(247,147,26,.4);border-radius:12px;padding:1rem;margin-top:1rem}
    table{width:100%;border-collapse:collapse;color:#fff;font-size:1rem;margin-top:1rem}
    th{border-bottom:2px solid #f7931a;padding:8px}
    td{padding:8px;border-bottom:1px solid #444}
    .ava{width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle}
  </style>
</head>
<body>
  <h1>‚õèÔ∏è BTC TX Battle Royale</h1>
  <p>Round #<span id="rnd">190</span> ‚Äî Target block #<span id="tgt">913889</span></p>

  <div class="prediction-input">
    <input id="guess" type="number" min="1000" max="10000" placeholder="Your tx count">
    <br><button onclick="submit()">üéØ Submit Guess</button>
  </div>

  <div id="shareBox" style="display:none">
    <p>‚úÖ  Your guess <strong id="myGuess"></strong> is locked in!</p>
    <button onclick="shareResult(document.getElementById('myGuess').textContent, tgtBlock)">üì£  Share on Warpcast</button>
  </div>

  <!--  NEW FULL TABLE  -->
  <div style="margin-top:1.5rem">
    <h3 style="color:#f7931a">üèÜ  Live Leaderboard</h3>
    <table id="lbTable">
      <thead><tr><th>#</th><th>Player</th><th>Guess</th></tr></thead>
      <tbody id="lbBody"><tr><td colspan="3">Loading‚Ä¶</td></tbody>
    </table>
  </div>

  <script type="module">
    import{sdk}from'https://unpkg.com/@farcaster/miniapp-sdk@0.1.0/dist/index.js';
    window.FC=sdk;  const tgtBlock=913889;
    document.getElementById('rnd').textContent=190;
    document.getElementById('tgt').textContent=tgtBlock;
    await FC.actions.ready();   // splash hidden
    fetchLeaderboard();

    async function submit(){
      const g=+document.getElementById('guess').value;
      if (!g||g<1000||g>10000) return alert('1000-10000 only');
      let signedMsg=null;
      try{ signedMsg=await window.FC.actions.signMessage({message:'predict'}); }catch{/*guest*/}
      const res=await fetch('/api/predictions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({signedMessage:signedMsg,blockHeight:tgtBlock,guess:g})});
      const j=await res.json(); if(j.error)return alert(j.error);
      document.querySelector('.prediction-input').style.display='none';
      document.getElementById('shareBox').style.display='block';
      document.getElementById('myGuess').textContent=g;
      if(j.user)document.getElementById('myGuess').insertAdjacentHTML('afterend',`<br><small>as <b>${j.user.displayName||j.user.username}</b></small>`);
      fetchLeaderboard();
    }
    async function fetchLeaderboard(){
      const res=await fetch(`/api/predictions?type=leaderboard&blockHeight=${tgtBlock}`);
      const { all } = await res.json();
      const tbody=document.getElementById('lbBody');
      if(!all||all.length===0){tbody.innerHTML='<tr><td colspan="3">No guesses yet</td></tr>';return;}
      tbody.innerHTML=all.map((p,i)=>{
        const status=p.diff===null?'<small style="color:#ffa">waiting for block</small>':`<small style="color:#8f8">off ${p.diff}</small>`;
        const avatar=p.avatar?`<img src="${p.avatar}" class="ava">`:'';
        return `<tr>
                  <td>${i+1}</td>
                  <td>${avatar}${p.displayName||p.username}</td>
                  <td>${p.guess.toLocaleString()} tx<br>${status}</td>
                </tr>`;
      }).join('');
    }
    window.shareResult=async(guess,block)=>{
      const text=`I guessed ${guess} tx for BTC block #${block}!\nThink you can beat me?\n\nPlay üëâ `;
      await FC.actions.composeText({ text: text + location.href });
    };
    setInterval(fetchLeaderboard,30000);
  </script>
</body>
</html>
