<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC TX Battle Royale</title>
  <style>
    body {
      font-family: system-ui;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 2rem;
    }
    .user-list {
      margin-top: 2rem;
      text-align: left;
    }
    .user-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .user-list th, .user-list td {
      padding: 10px;
      border-bottom: 1px solid #444;
    }
    .user-list th {
      color: #f7931a;
    }
    .user-list img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>‚õèÔ∏è BTC TX Battle Royale</h1>
  <p>Round #<span id="rnd">190</span> ‚Äî Target block #<span id="tgt">913889</span></p>

  <div class="prediction-input">
    <input id="guess" type="number" min="1000" max="10000" placeholder="Your tx count">
    <br><button onclick="submit()">üéØ Submit Guess</button>
  </div>

  <div id="shareBox" style="display:none">
    <p>‚úÖ  Your guess <strong id="myGuess"></strong> is locked in!</p>
    <button onclick="shareResult()">üì£  Share on Warpcast</button>
  </div>

  <div class="user-list">
    <h3 style="color:#f7931a">Players Who Joined</h3>
    <table id="userTable">
      <thead>
        <tr>
          <th>Avatar</th>
          <th>FID</th>
          <th>Username</th>
        </tr>
      </thead>
      <tbody id="userBody">
        <tr><td colspan="3">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.1.10';
    window.FC = sdk;

    // Hide splash screen
    sdk.actions.ready().catch(e => console.error('Ready failed', e));
    setTimeout(() => document.dispatchEvent(new CustomEvent('farcaster-splash-hide')), 2000);

    const tgtBlock = 913889;
    document.getElementById('rnd').textContent = 190;
    document.getElementById('tgt').textContent = tgtBlock;

    async function submit() {
      const g = +document.getElementById('guess').value;
      if (!g || g < 1000 || g > 10000) return alert('1000-10000 only');
      let signedMsg = null;
      try {
        await window.FC.context;
        signedMsg = await window.FC.actions.signMessage({ message: 'predict' });
      } catch (e) { console.warn('sign cancelled', e); }

      const res = await fetch('/api/predictions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ signedMessage: signedMsg, blockHeight: tgtBlock, guess: g })
      });
      const j = await res.json();
      if (j.error) return alert(j.error);

      document.querySelector('.prediction-input').style.display = 'none';
      document.getElementById('shareBox').style.display = 'block';
      document.getElementById('myGuess').textContent = g;
      if (j.user?.displayName || j.user?.username) {
        document.getElementById('myGuess').insertAdjacentHTML('afterend', `<br><small>as <b>${j.user.displayName || j.user.username}</b></small>`);
      }
      fetchLeaderboard();
      fetchUsers();
    }

    async function fetchLeaderboard() {
      const res = await fetch(`/api/predictions?type=leaderboard&blockHeight=${tgtBlock}`);
      const { all } = await res.json();
      const tbody = document.getElementById('lbBody');
      if (!all || all.length === 0) { tbody.innerHTML = '<tr><td colspan="3">No guesses yet</td></tr>'; return; }
      tbody.innerHTML = all.map((p, i) => {
        const status = p.diff === null ? '<small style="color:#ffa">waiting for block</small>' : `<small style="color:#8f8">off ${p.diff}</small>`;
        const avatar = p.avatar ? `<img src="${p.avatar}" class="ava">` : '';
        return `<tr><td>${i + 1}</td><td>${avatar}${p.displayName || p.username}</td><td>${p.guess.toLocaleString()} tx<br>${status}</td></tr>`;
      }).join('');
    }

    async function fetchUsers() {
      const res = await fetch('/api/users');
      const { users } = await res.json();
      const tbody = document.getElementById('userBody');
      if (!users || users.length === 0) { tbody.innerHTML = '<tr><td colspan="3">No players yet</td></tr>'; return; }
      tbody.innerHTML = users.map(user => {
        const avatar = user.avatar ? `<img src="${user.avatar}" alt="${user.username}">` : '';
        return `<tr><td>${avatar}</td><td>${user.fid}</td><td>@${user.username}</td></tr>`;
      }).join('');
    }

    window.shareResult = async () => {
      const guess = document.getElementById('myGuess').textContent;
      const text = `I guessed ${guess} tx for BTC block #${tgtBlock}!\nThink you can beat me?\n\nPlay üëâ https://btc-tx-royale.netlify.app`;
      await sdk.actions.composeText({ text });
    };

    setInterval(fetchLeaderboard, 30000);
    setInterval(fetchUsers, 30000);
    fetchLeaderboard();
    fetchUsers();
  </script>
</body>
</html>
