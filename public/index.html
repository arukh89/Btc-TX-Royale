<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC TX Battle Royale</title>
  <style>
    body {
      font-family: system-ui;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 2rem;
    }
    .prediction-input {
      margin-bottom: 1rem;
    }
    .predictions-list {
      margin-top: 2rem;
      text-align: left;
    }
    .predictions-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .predictions-list th, .predictions-list td {
      padding: 10px;
      border-bottom: 1px solid #444;
    }
    .predictions-list th {
      color: #f7931a;
    }
    .predictions-list img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>‚õèÔ∏è BTC TX Battle Royale</h1>
  <p>Round #<span id="rnd">190</span> ‚Äî Target block #<span id="tgt">913889</span></p>

  <div class="prediction-input">
    <input id="fcUsername" type="text" placeholder="Your FC Username">
    <input id="guess" type="number" min="1000" max="10000" placeholder="Your tx count">
    <br><button onclick="submit()">üéØ Submit Guess</button>
  </div>

  <div id="shareBox" style="display:none">
    <p>‚úÖ  Your guess <strong id="myGuess"></strong> is locked in!</p>
    <button onclick="shareResult()">üì£  Share on Warpcast</button>
  </div>

  <div class="predictions-list">
    <h3 style="color:#f7931a">All Predictions</h3>
    <table id="predictionsTable">
      <thead>
        <tr>
          <th>Avatar</th>
          <th>FID</th>
          <th>Username</th>
          <th>Guess</th>
        </tr>
      </thead>
      <tbody id="predictionsBody">
        <tr><td colspan="4">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.1.10';
    window.FC = sdk;

    // Hide splash screen
    sdk.actions.ready().catch(e => console.error('Ready failed', e));
    setTimeout(() => document.dispatchEvent(new CustomEvent('farcaster-splash-hide')), 2000);

    const tgtBlock = 913889;
    document.getElementById('rnd').textContent = 190;
    document.getElementById('tgt').textContent = tgtBlock;

    async function submit() {
      const username = document.getElementById('fcUsername').value.trim();
      if (!username) return alert('Please enter your FC username');

      try {
        // Fetch user data by username
        const user = await fetchUserByUsername(username);
        if (!user) return alert('User not found');

        const g = +document.getElementById('guess').value;
        if (!g || g < 1000 || g > 10000) return alert('1000-10000 only');

        let signedMsg = null;
        try {
          await window.FC.context;
          signedMsg = await window.FC.actions.signMessage({ message: 'predict' });
        } catch (e) { console.warn('sign cancelled', e); }

        const res = await fetch('/api/predictions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signedMessage: signedMsg, blockHeight: tgtBlock, guess: g, username: user.username, fid: user.fid })
        });
        const j = await res.json();
        if (j.error) return alert(j.error);

        document.querySelector('.prediction-input').style.display = 'none';
        document.getElementById('shareBox').style.display = 'block';
        document.getElementById('myGuess').textContent = g;
        if (j.user?.displayName || j.user?.username) {
          document.getElementById('myGuess').insertAdjacentHTML('afterend', `<br><small>as <b>${j.user.displayName || j.user.username}</b></small>`);
        }
        fetchPredictions();
      } catch (error) {
        console.error('Error submitting guess:', error);
        alert('Failed to submit guess. Please try again.');
      }
    }

    async function fetchUserByUsername(username) {
      try {
        // Use the Neynar API to fetch user by username
        const neynarApiKey = 'DIA557C9-F55E-42F3-8987-0F2CA80DD4E';
        const neynarClientId = '30719794-4961-4a3a-9aeb-c0e33086a64e';
        const response = await fetch(`https://snapchain-api.neynar.com/v1/users?username=${encodeURIComponent(username)}`, {
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': neynarApiKey,
            'x-client-id': neynarClientId,
          },
        });
        const data = await response.json();
        if (!data.users || data.users.length === 0) return null;
        return data.users[0];
      } catch (error) {
        console.error('Error fetching user by username:', error);
        return null;
      }
    }

    async function fetchPredictions() {
      const res = await fetch('/api/predictions');
      const { predictions } = await res.json();
      const tbody = document.getElementById('predictionsBody');
      if (!predictions || predictions.length === 0) { tbody.innerHTML = '<tr><td colspan="4">No predictions yet</td></tr>'; return; }
      tbody.innerHTML = predictions.map(pred => {
        const avatar = pred.avatar ? `<img src="${pred.avatar}" alt="${pred.username}">` : '';
        return `<tr><td>${avatar}</td><td>${pred.fid}</td><td>@${pred.username}</td><td>${pred.guess.toLocaleString()}</td></tr>`;
      }).join('');
    }

    window.shareResult = async () => {
      const guess = document.getElementById('myGuess').textContent;
      const text = `I guessed ${guess} tx for BTC block #${tgtBlock}!\nThink you can beat me?\n\nPlay üëâ https://btc-tx-royale.netlify.app`;
      await sdk.actions.composeText({ text });
    };

    setInterval(fetchPredictions, 30000);
    fetchPredictions();
  </script>
</body>
</html>
